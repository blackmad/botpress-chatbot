{"version":3,"sources":["webpack:///webpack/bootstrap 260083214824e723d674","webpack:///external \"lodash\"","webpack:///./src/index.js","webpack:///external \"botpress-version-manager\"","webpack:///./src/db.js","webpack:///external \"bluebird\"","webpack:///external \"botpress\""],"names":["db","config","incomingMiddleware","event","next","includes","type","getUserSession","session","is_new_session","bp","events","emit","appendMessageToSession","id","message","paused","logger","debug","text","outgoingMiddleware","module","exports","sessionExpiry","default","env","init","configurator","botpressPath","middlewares","register","name","order","handler","description","loadAll","get","knex","initialize","ready","hitl","pause","platform","userId","setSessionPaused","then","sessionId","unpause","isPaused","isSessionPaused","router","getRouter","req","res","getAllSessions","query","onlyPaused","send","sessions","getSessionData","params","messages","post","body","getSession","raw","to","user","sendOutgoing","sendStatus","where","select","limit","users","length","createUserSession","JSON","parse","Error","createTableIfNotExists","table","increments","primary","string","timestamp","boolean","schema","alterTable","index","catch","integer","references","onDelete","jsonb","enu","profileUrl","full_name","Math","random","toString","substr","first_name","last_name","profile_pic","picture_url","channelId","channel","options","user_image_url","last_event_on","date","now","last_heard_on","paused_trigger","stringify","insert","returning","dbSession","toPlainObject","object","mapValues","v","sql","buildUpdate","direction","session_id","raw_message","ts","join","update","trigger","parseInt","toBool","bool","s","condition","true","from","groupBy","as","whereRaw","orderBy","total","results","k"],"mappings":"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","file":"node.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/home/epaminond/private/projects/2015.08.08_keenethics/projects/botpress/botpress/packages/functionals/botpress-hitl\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 1);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 260083214824e723d674","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 0\n// module chunks = 0","import checkVersion from 'botpress-version-manager'\nimport DB from './db'\nimport _ from 'lodash'\n\n// TODO: Cleanup old sessions\n// TODO: If messages count > X, delete some\n\nlet db = null\nlet config = null\n\nconst incomingMiddleware = async (event, next) => {\n  if (!db) {\n    return next()\n  }\n\n  if (_.includes(['delivery', 'read'], event.type)) {\n    return next()\n  }\n\n  const session = await db.getUserSession(event)\n  if (!session) {\n    return next()\n  }\n\n  if (session.is_new_session) {\n    event.bp.events.emit('hitl.session', session)\n  }\n\n  const message = await db.appendMessageToSession(event, session.id, 'in')\n  event.bp.events.emit('hitl.message', message)\n  if ((!!session.paused || config.paused) && _.includes(['text', 'message', 'quick_reply'], event.type)) {\n    event.bp.logger.debug('[hitl] Session paused, message swallowed:', event.text)\n    // the session or bot is paused, swallow the message\n    return\n  }\n  next()\n}\n\nconst outgoingMiddleware = async (event, next) => {\n  if (!db) {\n    return next()\n  }\n\n  const session = await db.getUserSession(event)\n  if (!session) {\n    return next()\n  }\n\n  if (session.is_new_session) {\n    event.bp.events.emit('hitl.session', session)\n  }\n\n  const message = await db.appendMessageToSession(event, session.id, 'out')\n\n  event.bp.events.emit('hitl.message', message)\n  next()\n}\n\nmodule.exports = {\n  config: {\n    sessionExpiry: { type: 'string', default: '3 days' },\n    paused: { type: 'bool', default: false, env: 'BOTPRESS_HITL_PAUSED' }\n  },\n\n  init: async (bp, configurator) => {\n    checkVersion(bp, bp.botpressPath)\n\n    bp.middlewares.register({\n      name: 'hitl.captureInMessages',\n      type: 'incoming',\n      order: 2,\n      handler: incomingMiddleware,\n      module: 'botpress-hitl',\n      description: 'Captures incoming messages and if the session if paused, swallow the event.'\n    })\n\n    bp.middlewares.register({\n      name: 'hitl.captureOutMessages',\n      type: 'outgoing',\n      order: 50,\n      handler: outgoingMiddleware,\n      module: 'botpress-hitl',\n      description: 'Captures outgoing messages to show inside HITL.'\n    })\n\n    config = await configurator.loadAll()\n\n    const knex = await bp.db.get()\n    db = DB(knex)\n    return db.initialize()\n  },\n\n  ready: function(bp) {\n    bp.hitl = {\n      pause: (platform, userId) => {\n        return db.setSessionPaused(true, platform, userId, 'code').then(sessionId => {\n          bp.events.emit('hitl.session', { id: sessionId })\n          bp.events.emit('hitl.session.changed', { id: sessionId, paused: 1 })\n        })\n      },\n      unpause: (platform, userId) => {\n        return db.setSessionPaused(false, platform, userId, 'code').then(sessionId => {\n          bp.events.emit('hitl.session', { id: sessionId })\n          bp.events.emit('hitl.session.changed', { id: sessionId, paused: 0 })\n        })\n      },\n      isPaused: (platform, userId) => {\n        return db.isSessionPaused(platform, userId)\n      }\n    }\n\n    const router = bp.getRouter('botpress-hitl')\n\n    router.get('/sessions', (req, res) => {\n      db.getAllSessions(req.query.onlyPaused === 'true').then(sessions => res.send(sessions))\n    })\n\n    router.get('/sessions/:sessionId', (req, res) => {\n      db.getSessionData(req.params.sessionId).then(messages => res.send(messages))\n    })\n\n    router.post('/sessions/:sessionId/message', (req, res) => {\n      const { message } = req.body\n\n      db.getSession(req.params.sessionId).then(async session => {\n        const event = {\n          type: 'text',\n          platform: session.platform,\n          raw: { ...session.raw, to: session.userId, message: message },\n          user: { id: session.userId },\n          text: message\n        }\n\n        await bp.middlewares.sendOutgoing(event)\n\n        res.sendStatus(200)\n      })\n    })\n\n    // TODO post /sessions/:id/typing\n\n    router.post('/sessions/:sessionId/pause', (req, res) => {\n      db\n        .setSessionPaused(true, null, null, 'operator', req.params.sessionId)\n        .then(sessionId => {\n          bp.events.emit('hitl.session', { id: sessionId })\n          bp.events.emit('hitl.session.changed', { id: sessionId, paused: 1 })\n        })\n        .then(res.sendStatus(200))\n    })\n\n    router.post('/sessions/:sessionId/unpause', (req, res) => {\n      db\n        .setSessionPaused(false, null, null, 'operator', req.params.sessionId)\n        .then(sessionId => {\n          bp.events.emit('hitl.session', { id: sessionId })\n          bp.events.emit('hitl.session.changed', { id: sessionId, paused: 0 })\n        })\n        .then(res.sendStatus(200))\n    })\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","module.exports = require(\"botpress-version-manager\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress-version-manager\"\n// module id = 3\n// module chunks = 0","import Promise from 'bluebird'\nimport _ from 'lodash'\nimport { DatabaseHelpers as helpers } from 'botpress'\n\nlet knex = null\n\nfunction initialize() {\n  if (!knex) {\n    throw new Error('you must initialize the database before')\n  }\n\n  return helpers(knex)\n    .createTableIfNotExists('hitl_sessions', table => {\n      table.increments('id').primary()\n      table.string('platform')\n      table.string('userId')\n      table.string('full_name')\n      table.string('user_image_url')\n      table.timestamp('last_event_on')\n      table.timestamp('last_heard_on')\n      table.boolean('paused')\n      table.string('paused_trigger')\n    })\n    .then(() =>\n      knex.schema\n        .alterTable('hitl_sessions', table => {\n          table.index(['platform', 'userId'])\n        })\n        // most likely it will fail when the index already exists\n        // and creating it is not critical so this looks like\n        // a safe Q&D approach\n        .catch(() => {})\n    )\n    .then(() =>\n      helpers(knex).createTableIfNotExists('hitl_messages', table => {\n        table.increments('id').primary()\n        table\n          .integer('session_id')\n          .references('hitl_sessions.id')\n          .onDelete('CASCADE')\n        table.string('type')\n        table.string('text', 640)\n        table.jsonb('raw_message')\n        table.enu('direction', ['in', 'out'])\n        table.timestamp('ts')\n      })\n    )\n}\n\nfunction createUserSession(event) {\n  let raw = {}\n  let profileUrl = null\n  let full_name =\n    '#' +\n    Math.random()\n      .toString()\n      .substr(2)\n\n  if (event.user && event.user.first_name && event.user.last_name) {\n    profileUrl = event.user.profile_pic || event.user.picture_url\n    full_name = event.user.first_name + ' ' + event.user.last_name\n  }\n\n  if (event.platform === 'slack') {\n    raw = {\n      channelId: event.channel.id,\n      options: {}\n    }\n  }\n\n  const session = {\n    platform: event.platform,\n    userId: event.user.id,\n    user_image_url: profileUrl,\n    last_event_on: helpers(knex).date.now(),\n    last_heard_on: helpers(knex).date.now(),\n    paused: 0,\n    full_name: full_name,\n    paused_trigger: null,\n    raw: JSON.stringify(raw)\n  }\n\n  return knex('hitl_sessions')\n    .insert(session)\n    .returning('id')\n    .then(([id]) =>\n      knex('hitl_sessions')\n        .where({ id })\n        .then()\n        .get(0)\n    )\n    .then(dbSession => ({ is_new_session: true, ...dbSession }))\n}\n\nasync function getUserSession(event) {\n  const userId = (event.user && event.user.id) || event.raw.to\n\n  if (!userId) {\n    return null\n  }\n\n  return knex('hitl_sessions')\n    .where({ platform: event.platform, userId: userId })\n    .select('*')\n    .limit(1)\n    .then(users => {\n      if (!users || users.length === 0) {\n        return createUserSession(event)\n      } else {\n        users[0].raw = typeof users[0].raw === 'string' ? JSON.parse(users[0].raw) : null\n\n        return users[0]\n      }\n    })\n}\n\nfunction getSession(sessionId) {\n  return knex('hitl_sessions')\n    .where({ id: sessionId })\n    .select('*')\n    .limit(1)\n    .then(users => {\n      if (!users || users.length === 0) {\n        return null\n      } else {\n        users[0].raw = typeof users[0].raw === 'string' ? JSON.parse(users[0].raw) : null\n\n        return users[0]\n      }\n    })\n}\n\nfunction toPlainObject(object) {\n  // trims SQL queries from objects\n  return _.mapValues(object, v => {\n    return v.sql ? v.sql : v\n  })\n}\nconst buildUpdate = direction => {\n  const now = helpers(knex).date.now()\n  return direction === 'in'\n    ? { last_event_on: now }\n    : {\n        last_event_on: now,\n        last_heard_on: now\n      }\n}\n\nfunction appendMessageToSession(event, sessionId, direction) {\n  const message = {\n    session_id: sessionId,\n    type: event.type,\n    text: event.text,\n    raw_message: event.raw,\n    direction: direction,\n    ts: helpers(knex).date.now()\n  }\n\n  return Promise.join(\n    knex('hitl_messages').insert(message),\n    knex('hitl_sessions')\n      .where({ id: sessionId })\n      .update(buildUpdate(direction)),\n    () => toPlainObject(message)\n  )\n}\n\nfunction setSessionPaused(paused, platform, userId, trigger, sessionId = null) {\n  if (sessionId) {\n    return knex('hitl_sessions')\n      .where({ id: sessionId })\n      .update({ paused: paused ? 1 : 0, paused_trigger: trigger })\n      .then(() => parseInt(sessionId))\n  } else {\n    return knex('hitl_sessions')\n      .where({ userId, platform })\n      .update({ paused: paused ? 1 : 0, paused_trigger: trigger })\n      .then(() => {\n        return knex('hitl_sessions')\n          .where({ userId, platform })\n          .select('id')\n      })\n      .then(sessions => parseInt(sessions[0].id))\n  }\n}\n\nfunction isSessionPaused(platform, userId, sessionId = null) {\n  const toBool = s => helpers(knex).bool.parse(s)\n\n  if (sessionId) {\n    return knex('hitl_sessions')\n      .where({ id: sessionId })\n      .select('paused')\n      .then()\n      .get(0)\n      .then(s => s && toBool(s.paused))\n  } else {\n    return knex('hitl_sessions')\n      .where({ userId, platform })\n      .select('paused')\n      .then()\n      .get(0)\n      .then(s => s && toBool(s.paused))\n  }\n}\n\nfunction getAllSessions(onlyPaused) {\n  let condition = ''\n\n  if (onlyPaused === true) {\n    condition = 'hitl_sessions.paused = ' + helpers(knex).bool.true()\n  }\n\n  return knex\n    .select('*')\n    .from(function() {\n      this.select([knex.raw('max(id) as mId'), 'session_id', knex.raw('count(*) as count')])\n        .from('hitl_messages')\n        .groupBy('session_id')\n        .as('q1')\n    })\n    .join('hitl_messages', knex.raw('q1.mId'), 'hitl_messages.id')\n    .join('hitl_sessions', knex.raw('q1.session_id'), 'hitl_sessions.id')\n    .whereRaw(condition)\n    .orderBy('hitl_sessions.last_event_on', 'desc')\n    .limit(100)\n    .then(results => ({\n      total: 0,\n      sessions: results\n    }))\n}\n\nfunction getSessionData(sessionId) {\n  return knex('hitl_sessions')\n    .where({ session_id: sessionId })\n    .join('hitl_messages', 'hitl_messages.session_id', 'hitl_sessions.id')\n    .orderBy('hitl_messages.id', 'desc')\n    .limit(100)\n    .select('*')\n    .then(messages => _.orderBy(messages, ['id'], ['asc']))\n}\n\nmodule.exports = k => {\n  knex = k\n\n  return {\n    initialize,\n    getUserSession,\n    setSessionPaused,\n    appendMessageToSession,\n    getAllSessions,\n    getSessionData,\n    getSession,\n    isSessionPaused\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/db.js","module.exports = require(\"bluebird\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird\"\n// module id = 5\n// module chunks = 0","module.exports = require(\"botpress\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress\"\n// module id = 6\n// module chunks = 0"],"sourceRoot":""}