{"version":3,"sources":["webpack:///webpack/bootstrap 38ae9757d05c9d4466db","webpack:///external \"lodash\"","webpack:///./src/util.js","webpack:///./src/index.js","webpack:///external \"twilio\"","webpack:///external \"querystring\"","webpack:///external \"body-parser\"","webpack:///./src/umm.js","webpack:///external \"util\"","webpack:///external \"bluebird\""],"names":["extractNumber","event","number","_","get","Error","module","exports","client","config","accountSID","type","required","env","authToken","fromNumber","messagingServiceSid","init","bp","configurator","handleOutgoing","next","console","log","platform","payload","to","body","text","mediaUrl","image","isNil","from","messages","create","then","_promise","_resolve","middlewares","register","name","order","handler","description","loadAll","twilio","ready","id","db","knex","where","users","existingUser","newUser","first_name","last_name","profile_pic","saveUser","getOrCreateUser","logDebug","message","process","TWILIO_DEBUG","logger","debug","router","getRouter","use","bodyParser","urlencoded","extended","post","req","res","headers","host","originalUrl","valid","validateExpressRequest","protocol","sendStatus","send","Body","From","fromCountry","FromCountry","fromCity","FromCity","fromState","FromState","smsSid","SmsSid","messageSid","SmsMessageSid","_toNumber","To","_accountSid","AccountSid","user","sendIncoming","raw","PromisifyEvent","Promise","resolve","reject","_reject","processOutgoing","blocName","instruction","ins","Object","assign","optionsList","options","pick","prop","isImageLink","url","startsWith","endsWith","msgType","strRep","util","inspect","at","renderers","registerConnector","args","templates"],"mappings":"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","file":"node.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 2);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 38ae9757d05c9d4466db","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 0\n// module chunks = 0","import _ from 'lodash'\n\nfunction extractNumber(event) {\n  const number = _.get(event, 'user.number')\n    || _.get(event, 'number')\n    || _.get(event, 'raw.to')\n    || _.get(event, 'raw.number')\n    || _.get(event, 'user.userId')\n\n  if (!number) {\n    throw new Error('Could not extract user phone number number from event')\n  }\n\n  return number\n}\n\nmodule.exports = { extractNumber }\n\n\n\n// WEBPACK FOOTER //\n// ./src/util.js","import twilio from 'twilio'\nimport qs from 'querystring'\nimport _ from 'lodash'\nimport bodyParser from 'body-parser'\n\nimport { extractNumber } from './util'\nimport UMM from './umm'\n\nlet client = null\n\nmodule.exports = {\n\n  config: {\n    accountSID: { type: 'string', required: true, env: 'TWILIO_ACCOUNT_SID' },\n    authToken: { type: 'string', required: true, env: 'TWILIO_AUTH_TOKEN' },\n    fromNumber: { type: 'string', required: false, env: 'TWILIO_FROM' },\n    messagingServiceSid: { type: 'string', required: false, env: 'TWILIO_MESSAGING_SERVICE_SID' }\n  },\n\n  init: async function(bp, configurator) {\n    bp.middlewares.register({\n      name: 'twilio.sendSms',\n      type: 'outgoing',\n      order: 100,\n      handler: handleOutgoing,\n      module: 'botpress-twilio',\n      description: 'Sends out text messages by SMS using Twilio'\n    })\n\n    const {\n      accountSID,\n      authToken,\n      fromNumber,\n      messagingServiceSid\n    } = await configurator.loadAll()\n\n    client = new twilio(accountSID, authToken)\n\n    function handleOutgoing(event, next) {\n      console.log('handle outgoing')\n      console.log('twilio index')\n      if (event.platform !== 'twilio') {\n        // Only process twilio messages\n        return next()\n      }\n      console.log(next)\n\n      const payload = {\n        to: extractNumber(event),\n        body: event.text,\n        mediaUrl: event.image\n      }\n\n      if (!_.isNil(fromNumber)) {\n        payload.from = fromNumber;\n      } else {\n        payload.messagingServiceSid = messagingServiceSid\n      }\n\n      console.log(payload)\n\n      client.messages.create(payload)\n      .then(() => {\n        if (event._promise && event._resolve) {\n          event._resolve()\n        }\n      })\n    }\n\n    UMM(bp)\n  },\n\n  ready: async function(bp, configurator) {\n\n    function logDebug(message) {\n      if (process.env.TWILIO_DEBUG) {\n        bp.logger.debug('[XXXX Twilio] ' + message)\n      }\n    }\n\n    async function getOrCreateUser(fromNumber) {\n      const id = `twilio:${fromNumber}`;\n      const existingUser = await bp.db.get()\n        .then(knex => knex('users').where('id', id))\n        .then(users => users[0]);\n\n      if (existingUser) {\n        existingUser.id = fromNumber;\n        return existingUser;\n\n      } else {\n        const newUser = {\n          first_name: 'Unknown',\n          last_name: 'Unknown',\n          profile_pic: null,\n          id: fromNumber,\n          platform: 'twilio',\n          number: fromNumber\n        }\n\n        await bp.db.saveUser(newUser);\n        return newUser;\n      }\n    }\n\n    bp.twilio = { getOrCreateUser }\n\n    const router = bp.getRouter('botpress-twilio', {\n      'bodyParser.json': false,\n      'auth': false,\n      'bodyParser.urlencoded': false\n    })\n\n    router.use(bodyParser.urlencoded({\n      extended: false\n    }))\n\n    const { authToken } = await configurator.loadAll()\n\n    router.post('/webhook', async (req, res) => {\n      logDebug(`Kill Yr Idols Incoming Twilio Message [HOST='${req.headers.host}'] [URL='${req.originalUrl}']`)\n\n      const valid = twilio.validateExpressRequest(req, authToken, { protocol: 'https' })\n\n      if (!valid) {\n        logDebug('Signature verification failed')\n        return res.sendStatus(403)\n      }\n\n      logDebug('Message verified')\n      // res.sendStatus(200)\n      res.send('<Response></Response>')\n\n      const {\n        Body: message,\n        From: fromNumber,\n        FromCountry: fromCountry,\n        FromCity: fromCity,\n        FromState: fromState,\n        SmsSid: smsSid,\n        SmsMessageSid: messageSid,\n        To: _toNumber,\n        AccountSid: _accountSid\n       } = req.body || {}\n\n       const user = await getOrCreateUser(fromNumber)\n\n       bp.middlewares.sendIncoming({\n        platform: 'twilio',\n        type: 'message',\n        user: user,\n        text: message,\n        raw: { message, fromNumber, fromCountry, fromCity, fromState, smsSid, messageSid }\n      })\n\n      logDebug('Message delivered to bot')\n    })\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","module.exports = require(\"twilio\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"twilio\"\n// module id = 4\n// module chunks = 0","module.exports = require(\"querystring\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"querystring\"\n// module id = 5\n// module chunks = 0","module.exports = require(\"body-parser\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"body-parser\"\n// module id = 6\n// module chunks = 0","import util from 'util'\nimport _ from 'lodash'\nimport Promise from 'bluebird'\n\nimport { extractNumber } from './util'\n\nfunction PromisifyEvent(event) {\n  if (!event._promise) {\n    event._promise = new Promise((resolve, reject) => {\n      event._resolve = resolve\n      event._reject = reject\n    })\n  }\n\n  return event\n}\n\nfunction processOutgoing({ event, blocName, instruction }) {\n  const ins = Object.assign({}, instruction) // Create a shallow copy of the instruction\n  console.log('twilio umm')\n  console.log(instruction)\n\n  ////////\n  // PRE-PROCESSING\n  ////////\n\n  const optionsList = ['typing']\n\n  const options = _.pick(instruction, optionsList)\n\n  for (let prop of optionsList) {\n    delete ins[prop]\n  }\n\n  /////////\n  /// Processing\n  /////////\n\n  function isImageLink(url) {\n    return _.startsWith(url, 'http') && (\n      _.endsWith(url, 'jpg') ||\n      _.endsWith(url, 'jpeg') ||\n      _.endsWith(url, 'gif') ||\n      _.endsWith(url, 'png')\n    )\n  }\n\n  if (!_.isNil(instruction.text) || !_.isNil(instruction.image)) {\n    const number = extractNumber(event);\n\n    var text = instruction.text || '';\n    var image = instruction.image;\n    if (isImageLink(text)) {\n      image = text;\n      text = ''\n    }\n\n    const msgType = !_.isNil(image) ? 'image' : 'text';\n\n\n    return PromisifyEvent({\n      platform: 'twilio',\n      type: msgType,\n      user: { id: number, number },\n      raw: Object.assign({ to: number, message: instruction.text }, options),\n      text: text,\n      image: image\n    })\n  }\n\n  ////////////\n  /// POST-PROCESSING\n  ////////////\n\n  // Nothing to post-process yet\n\n  ////////////\n  /// INVALID INSTRUCTION\n  ////////////\n\n  const strRep = util.inspect(instruction, false, 1)\n  throw new Error(`Unrecognized instruction in Twilio in bloc '${blocName}': ${strRep}`)\n}\n\nmodule.exports = bp => {\n  const [renderers, registerConnector] = _.at(bp, ['renderers', 'renderers.registerConnector'])\n\n  renderers && registerConnector && registerConnector({\n    platform: 'twilio',\n    processOutgoing: args => processOutgoing(Object.assign({}, args, { bp })),\n    templates: []\n  })\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/umm.js","module.exports = require(\"util\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"util\"\n// module id = 8\n// module chunks = 0","module.exports = require(\"bluebird\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird\"\n// module id = 9\n// module chunks = 0"],"sourceRoot":""}