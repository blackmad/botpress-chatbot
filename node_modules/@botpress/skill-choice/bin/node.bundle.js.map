{"version":3,"sources":["webpack:///webpack/bootstrap f643e8850acb5aa396ca","webpack:///./src/index.js","webpack:///external \"lodash\"","webpack:///external \"@botpress/util-sdk\""],"names":["botpress","config","INTENT_PREFIX","checkCategoryAvailable","contentManager","listAvailableCategories","map","c","id","categories","includes","defaultContentElement","logger","warn","module","exports","type","required","default","env","defaultContentRenderer","defaultMaxAttempts","matchNumbers","disableIntegrityCheck","matchNLU","init","bp","configurator","loadAll","ready","setTimeout","router","getRouter","get","req","res","send","pick","dialogEngine","registerActions","state","data","text","payload","nlu","choice","nb","match","index","parseInt","getItem","contentId","element","findKey","keywords","intents","filter","x","toLowerCase","startsWith","substr","length","some","intent","is","k","key","generate","invalidTextData","invalidText","maxAttempts","nbMaxRetries","flow","Flow","nodes","Node","name","onEnter","renderElement","skill","next","condition","node","onReceive","runAction","transitions","Object","keys","choiceShort","caption","push"],"mappings":"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","file":"node.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap f643e8850acb5aa396ca","import _ from 'lodash'\nimport { Skill } from '@botpress/util-sdk'\n\nlet botpress = null\nlet config = null\nconst INTENT_PREFIX = 'intent:'\n\nconst checkCategoryAvailable = async () => {\n  const categories = await botpress.contentManager.listAvailableCategories().map(c => c.id)\n\n  if (!categories.includes(config.defaultContentElement)) {\n    botpress.logger.warn(\n      `[Skill/Choice] Configured to use Content Element \"${config.defaultContentElement}\", but it was not found.`\n    )\n\n    if (config.defaultContentElement === 'builtin_single-choice') {\n      botpress.logger.warn(`[Skill/Choice] You should probably install (and use) the @botpress/builtins \nmodule OR change the \"defaultContentElement\" in this module's configuration to use your own content element.`)\n    }\n\n    return\n  }\n}\n\nmodule.exports = {\n  config: {\n    defaultContentElement: {\n      type: 'string',\n      required: true,\n      default: 'builtin_single-choice',\n      env: 'SKILL_CHOICE_CONTENT_ELEMENT'\n    },\n    defaultContentRenderer: {\n      type: 'string',\n      required: true,\n      default: '#builtin_single-choice',\n      env: 'SKILL_CHOICE_CONTENT_RENDERER'\n    },\n    defaultMaxAttempts: { type: 'string', required: false, default: '3', env: 'SKILL_CHOICE_MAX_ATTEMPTS' },\n    matchNumbers: { type: 'bool', required: false, default: true, env: 'SKILL_CHOICE_MATCH_NUMBERS' },\n    disableIntegrityCheck: { type: 'bool', required: false, default: false, env: 'SKILL_DISABLE_INTEGRITY_CHECK' },\n    matchNLU: { type: 'bool', required: false, default: true, env: 'SKILL_CHOICE_MATCH_NLU' }\n  },\n\n  init: async function(bp, configurator) {\n    botpress = bp\n    config = await configurator.loadAll()\n  },\n\n  ready: async function(bp, configurator) {\n    if (!config.disableIntegrityCheck) {\n      setTimeout(checkCategoryAvailable, 3000)\n    }\n\n    const router = bp.getRouter('botpress-skill-choice')\n\n    router.get('/config', (req, res) => {\n      res.send(\n        _.pick(config, ['defaultContentElement', 'defaultContentRenderer', 'defaultMaxAttempts', 'matchNumbers'])\n      )\n    })\n\n    bp.dialogEngine.registerActions({\n      '__skill-choice-parse': async function(state, { text, payload, nlu }, data) {\n        let choice = null\n\n        const nb = _.get(text.match(/^[#).!]?([\\d]{1,2})[#).!]?$/), '[1]')\n        if (config.matchNumbers && nb) {\n          const index = parseInt(nb) - 1\n          const element = await botpress.contentManager.getItem(data.contentId)\n          choice = _.get(element, `data.choices.${index}.value`)\n        }\n\n        if (!choice && config.matchNLU && typeof _.get(nlu, 'intent.is') === 'function') {\n          choice = _.findKey(data.keywords, keywords => {\n            const intents = keywords\n              .filter(x => x.toLowerCase().startsWith(INTENT_PREFIX))\n              .map(x => x.substr(INTENT_PREFIX.length))\n            return _.some(intents, k => nlu.intent.is(k))\n          })\n        }\n\n        if (!choice) {\n          choice = _.findKey(data.keywords, keywords =>\n            _.some(\n              keywords || [],\n              k =>\n                _.includes(text.toLowerCase(), k.toLowerCase()) ||\n                (payload && _.includes(payload.toLowerCase(), k.toLowerCase()))\n            )\n          )\n        }\n\n        if (choice) {\n          return {\n            ...state,\n            'skill-choice-valid': true,\n            'skill-choice-ret': choice\n          }\n        } else {\n          return { ...state, 'skill-choice-valid': false }\n        }\n      },\n\n      '__skill-choice-invalid-inc': function(state) {\n        const key = 'skill-choice-invalid-count'\n        return { ...state, [key]: (state[key] || 0) + 1 }\n      }\n    })\n  },\n\n  generate: async function(data) {\n    const invalidTextData = {}\n    if (data.config.invalidText && data.config.invalidText.length) {\n      invalidTextData.text = data.config.invalidText\n    }\n\n    const maxAttempts = data.config.nbMaxRetries || config.defaultMaxAttempts\n\n    const flow = Skill.Flow({\n      nodes: [\n        Skill.Node({\n          name: 'entry',\n          onEnter: [Skill.renderElement('#!' + data.contentId, { skill: 'choice' })],\n          next: [{ condition: 'true', node: 'parse' }]\n        }),\n        Skill.Node({\n          name: 'parse',\n          onReceive: [Skill.runAction('__skill-choice-parse', data)],\n          next: [\n            { condition: \"state['skill-choice-valid'] === true\", node: '#' },\n            { condition: 'true', node: 'invalid' }\n          ]\n        }),\n        Skill.Node({\n          name: 'invalid',\n          onEnter: [Skill.runAction('__skill-choice-invalid-inc')],\n          next: [\n            { condition: `state['skill-choice-invalid-count'] <= ${maxAttempts}`, node: 'sorry' },\n            { condition: 'true', node: '#' }\n          ]\n        }),\n        Skill.Node({\n          name: 'sorry',\n          onEnter: [Skill.renderElement('#!' + data.contentId, { ...invalidTextData, skill: 'choice' })], // TODO Make property configurable\n          next: [{ condition: 'true', node: 'parse' }]\n        })\n      ]\n    })\n\n    const transitions = Object.keys(data.keywords).map(choice => {\n      const choiceShort = choice.length > 8 ? choice.substr(0, 7) + '...' : choice\n\n      return {\n        caption: `User picked [${choiceShort}]`,\n        condition: `state['skill-choice-ret'] == \"${choice}\"`,\n        node: ''\n      }\n    })\n\n    transitions.push({\n      caption: 'On failure',\n      condition: 'true',\n      node: ''\n    })\n\n    return { transitions, flow }\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 2\n// module chunks = 0","module.exports = require(\"@botpress/util-sdk\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"@botpress/util-sdk\"\n// module id = 3\n// module chunks = 0"],"sourceRoot":""}