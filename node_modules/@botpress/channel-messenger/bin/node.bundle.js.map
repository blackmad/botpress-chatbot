{"version":3,"sources":["webpack:///webpack/bootstrap 61bafab298b779ef23f8","webpack:///external \"lodash\"","webpack:///./src/outgoing.js","webpack:///./src/db.js","webpack:///external \"bluebird\"","webpack:///./src/users.js","webpack:///./src/index.js","webpack:///./src/messenger.js","webpack:///external \"botpress\"","webpack:///external \"eventemitter2\"","webpack:///external \"crypto\"","webpack:///external \"node-fetch\"","webpack:///external \"body-parser\"","webpack:///./src/incoming.js","webpack:///external \"lru-cache\"","webpack:///./src/umm.js","webpack:///external \"util\"","webpack:///./src/actions.js"],"names":["handlePromise","next","promise","then","res","catch","err","handleText","event","messenger","sendTextMessage","raw","to","message","quick_replies","handleAttachment","sendAttachment","type","url","handleTemplate","sendTemplate","payload","handleTyping","sendTypingIndicator","typing","handleSeen","sendAction","module","exports","text","attachment","template","seen","pending","knex","initialize","Error","createTableIfNotExists","table","string","primary","addAttachment","attachment_id","insert","get","getAttachment","where","select","ret","hasAttachment","count","k","_","require","bp","userId","db","platform","user","dbEntryToProfile","Object","getUserProfile","id","profile","assign","saveUser","profileToDbEntry","getOrFetchUserProfile","users","map","getAllUsers","gender","timezone","locale","picture_url","profile_pic","first_name","last_name","outgoingPending","outgoingMiddleware","setValue","args","__id","message_id","timestamp","Date","getTime","mid","method","waitDelivery","waitRead","apply","initializeMessenger","configurator","loadAll","config","enabled","logger","warn","connect","updateSettings","error","hostname","defaultHostname","process","env","BOTPRESS_URL","NODE_ENV","match","applicationID","required","default","accessToken","appSecret","verifyToken","enableAllProfileFields","graphVersion","displayGetStarted","greetingMessage","persistentMenu","persistentMenuItems","validation","isArray","v","composerInputDisabled","automaticallyMarkAsRead","targetAudience","targetAudienceOpenToSome","targetAudienceCloseToSome","trustedDomains","autoResponseOption","autoResponseText","autoResponseTextRenderer","autoResponsePostback","paymentTesters","chatExtensionHomeUrl","chatExtensionInTest","chatExtensionShowShareButton","webhookSubscriptionFields","init","middlewares","register","name","order","handler","description","ready","_internal","Promise","EventEmitter","crypto","fetch","bodyParser","normalizeString","str","replace","toUpperCase","Messenger","setConfig","app","getRouter","auth","test","req","originalUrl","use","json","verify","_verifyRequestSignature","bind","_initWebhook","_setupNewWebhook","_subscribePage","_unsubscribePage","recipientId","quickReplies","options","formattedQuickReplies","_formatQuickReplies","length","sendMessage","buttons","template_type","formattedButtons","_formatButtons","elements","isReusable","isBoolean","is_reusable","attachmentId","action","sendRequest","recipient","sender_action","autoTimeout","timeout","headers","body","JSON","stringify","object_id","object","field","custom_fields","page_id","access_token","_handleFacebookResponse","endpoint","_handleEvent","token","response","milliseconds","isNaN","Math","min","before","resolve","delay","profileFields","concat","join","console","log","home_url","in_test","show_share","show_string","webview_height_ratio","webview_share_button","fields","setting","deleteChatExtensionHomeUrlSetting","createChatExtensionHomeUrlSetting","tester","setting_type","payment_dev_mode_action","payment_testers","createPaymentTesterSetting","sendThreadRequest","deletePaymentTesterSetting","_getPage","value","isGreetingMessageEmpty","isEmpty","composer_input_disabled","call_to_actions","_reformatPersistentMenuItems","audience_type","countries","whitelist","split","blacklist","indexOf","push","testers","messageConfigKeys","keys","reduce","settings","key","update","delete","factory","button","title","reply","content_type","image_url","emit","sender","postback","quick_reply","status","errorMessage","statusText","error_user_title","error_user_msg","finally","query","send","sendStatus","post","data","entry","forEach","messaging","is_echo","broadcastEchoes","_handleQuickReplyEvent","_handleMessageEvent","attachments","_handleAttachmentEvent","_handlePostbackEvent","delivery","read","account_linking","optin","referral","payment","buf","path","signature","hash","expectedHash","createHmac","digest","item","oAuthUrl","callback_url","verify_token","subscribed_fields","messagesCache","max","maxAge","preprocessEvent","has","alreadyProcessed","set","on","e","sendIncoming","att","mConfig","getConfig","renderers","sendToUser","values","includes","mids","watermark","toString","authorization_code","ref","QUICK_REPLY_PAYLOAD","processButtons","blocName","processQuickReplies","isNil","qrs","isString","qr","exec","startsWith","amendButtons","obj","isPlainObject","mapValues","getUserId","substr","processOutgoing","instruction","ins","optionsList","pick","prop","createTemplate","attr","createAttachment","createText","strRep","inspect","getTemplates","at","registerConnector","templates","create","reject","r","rj","messageId","toISOString","random","newEvent","_promise","_resolve","_reject","validateUserId","validateText","validateQuickReply","validateQuickReplies","validateTyping","isNumber","validateAttachmentType","toLowerCase","validateUrl","validateTemplatePayload","validatePersistentMenu","element","isNull","createTyping","createSeen","createPersistentMenu","createGreetingText","createGetStarted","createWhitelistedDomains","domains","every"],"mappings":"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","file":"node.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/home/epaminond/private/projects/2015.08.08_keenethics/projects/botpress/botpress/packages/channels/botpress-channel-messenger\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 5);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 61bafab298b779ef23f8","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 0\n// module chunks = 0","const handlePromise = (next, promise) => {\n  return promise\n    .then(res => {\n      next()\n      return res\n    })\n    .catch(err => {\n      next(err)\n      throw err\n    })\n}\n\nconst handleText = (event, next, messenger) => {\n  return handlePromise(\n    next,\n    messenger.sendTextMessage(event.raw.to, event.raw.message, event.raw.quick_replies, event.raw)\n  )\n}\n\nconst handleAttachment = (event, next, messenger) => {\n  return handlePromise(\n    next,\n    messenger.sendAttachment(event.raw.to, event.raw.type, event.raw.url, event.raw.quick_replies, event.raw)\n  )\n}\n\nconst handleTemplate = (event, next, messenger) => {\n  return handlePromise(next, messenger.sendTemplate(event.raw.to, event.raw.payload, event.raw))\n}\n\nconst handleTyping = (event, next, messenger) => {\n  return handlePromise(next, messenger.sendTypingIndicator(event.raw.to, event.raw.typing))\n}\n\nconst handleSeen = (event, next, messenger) => {\n  return handlePromise(next, messenger.sendAction(event.raw.to, 'mark_seen'))\n}\n\nmodule.exports = {\n  text: handleText,\n  attachment: handleAttachment,\n  template: handleTemplate,\n  typing: handleTyping,\n  seen: handleSeen,\n  pending: {}\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/outgoing.js","import { DatabaseHelpers } from 'botpress'\n\nlet knex = null\n\nfunction initialize() {\n  if (!knex) {\n    throw new Error('you must initialize the database before')\n  }\n\n  return DatabaseHelpers(knex)\n    .createTableIfNotExists('messenger_attachments', function(table) {\n      table.string('url').primary()\n      table.string('attachment_id')\n    })\n    .then()\n}\n\nfunction addAttachment(url, attachment_id) {\n  return knex('messenger_attachments')\n    .insert({ url, attachment_id })\n    .then()\n    .get(0)\n}\n\nfunction getAttachment(url) {\n  return knex('messenger_attachments')\n    .where('url', url)\n    .select('attachment_id')\n    .then()\n    .get(0)\n    .then(ret => {\n      return ret && ret.attachment_id\n    })\n}\n\nfunction hasAttachment(url) {\n  return knex('messenger_attachments')\n    .where('url', url)\n    .count('url as count')\n    .then(ret => {\n      return ret && ret[0] && ret[0].count === 1\n    })\n}\n\nmodule.exports = k => {\n  knex = k\n  return { initialize, addAttachment, getAttachment, hasAttachment }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/db.js","module.exports = require(\"bluebird\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird\"\n// module id = 3\n// module chunks = 0","const _ = require('lodash')\n\nmodule.exports = function(bp, messenger) {\n  function profileToDbEntry(profile) {\n    return {\n      id: 'facebook:' + profile.id,\n      userId: profile.id,\n      platform: 'facebook',\n      gender: profile.gender,\n      timezone: profile.timezone,\n      locale: profile.locale,\n      picture_url: profile.profile_pic,\n      first_name: profile.first_name,\n      last_name: profile.last_name\n    };\n  }\n\n  function dbEntryToProfile(db) {\n    return {\n      gender: db.gender,\n      timezone: db.timezone,\n      locale: db.locale,\n      profile_pic: db.picture_url,\n      first_name: db.first_name,\n      last_name: db.last_name,\n      userId: db.userId,\n      id: 'facebook:' + db.userId\n    };\n  }\n\n  async function getOrFetchUserProfile(userId) {\n    const knex = await bp.db.get()\n\n    const user = await knex('users')\n      .where({ platform: 'facebook', userId: userId })\n      .then()\n      .get(0)\n      .then()\n\n    if (user) {\n      return dbEntryToProfile(user)\n    }\n\n    const profile = Object.assign(await messenger.getUserProfile(userId), { id: userId })\n    await bp.db.saveUser(profileToDbEntry(profile))\n\n    return profile\n  }\n\n  async function getAllUsers() {\n    const knex = await bp.db.get()\n\n    const users = await knex('users')\n      .where({ platform: 'facebook' })\n      .then()\n\n    return (users || []).map(dbEntryToProfile)\n  }\n\n  return { getOrFetchUserProfile, getAllUsers }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/users.js","import _ from 'lodash'\n\nimport Messenger from './messenger'\nimport outgoing from './outgoing'\nimport incoming from './incoming'\nimport Users from './users'\nimport UMM from './umm'\nimport DB from './db'\n\nlet messenger = null\nconst outgoingPending = outgoing.pending\n\nlet users = null\n\nconst outgoingMiddleware = (event, next) => {\n  if (event.platform !== 'facebook') {\n    return next()\n  }\n\n  if (!outgoing[event.type]) {\n    return next('Unsupported event type: ' + event.type)\n  }\n\n  const setValue = method => (...args) => {\n    if (event.__id && outgoingPending[event.__id]) {\n      if (args && args[0] && args[0].message_id) {\n        outgoingPending[event.__id].timestamp = new Date().getTime() - 1000\n        outgoingPending[event.__id].mid = args[0].message_id\n      }\n\n      if (method === 'resolve' && (event.raw.waitDelivery || event.raw.waitRead)) {\n        // We skip setting this value because we wait\n      } else {\n        outgoingPending[event.__id][method].apply(null, args)\n        delete outgoingPending[event.__id]\n      }\n    }\n  }\n\n  outgoing[event.type](event, next, messenger).then(setValue('resolve'), setValue('reject'))\n}\n\nconst initializeMessenger = async (bp, configurator) => {\n  const config = await configurator.loadAll()\n\n  messenger = new Messenger(bp, config)\n  users = Users(bp, messenger)\n\n  const enabled = config.enabled\n\n  if (!enabled) {\n    return bp.logger.warn('[Messenger] Connection disabled')\n  }\n\n  return messenger\n    .connect()\n    .then(() => messenger.updateSettings())\n    .catch(err => bp.logger.error(err))\n}\n\nlet hostname = []\nconst defaultHostname =\n  process.env.BOTPRESS_URL && process.env.NODE_ENV === 'production'\n    ? (hostname = process.env.BOTPRESS_URL.match(/https:\\/\\/(.*?)\\//)) && hostname[1]\n    : ''\n\nmodule.exports = {\n  config: {\n    applicationID: { type: 'string', required: true, default: '', env: 'MESSENGER_APP_ID' },\n    accessToken: { type: 'string', required: true, default: '', env: 'MESSENGER_ACCESS_TOKEN' },\n    appSecret: { type: 'string', required: true, default: '', env: 'MESSENGER_APP_SECRET' },\n    verifyToken: { type: 'string', required: false, default: '', env: 'MESSENGER_VERIFY_TOKEN' },\n    enabled: { type: 'bool', required: true, default: true },\n    enableAllProfileFields: { type: 'bool', required: true, default: false },\n    hostname: { type: 'string', required: false, default: defaultHostname, env: 'MESSENGER_HOST' },\n\n    graphVersion: { type: 'string', required: true, default: '2.12' },\n    displayGetStarted: { type: 'bool', required: false, default: true },\n    greetingMessage: { type: 'string', required: false, default: 'Default greeting message' },\n    persistentMenu: { type: 'bool', required: false, default: false },\n    persistentMenuItems: { type: 'any', required: false, default: [], validation: v => _.isArray(v) },\n    composerInputDisabled: { type: 'bool', required: false, default: false },\n    automaticallyMarkAsRead: { type: 'bool', required: false, default: true },\n    targetAudience: { type: 'string', required: true, default: 'openToAll' },\n    targetAudienceOpenToSome: { type: 'string', required: false },\n    targetAudienceCloseToSome: { type: 'string', required: false },\n    trustedDomains: { type: 'any', required: false, default: [], validation: v => _.isArray(v) },\n\n    autoResponseOption: { type: 'string', required: false, default: 'autoResponseTextRenderer' },\n    autoResponseText: { type: 'string', required: false, default: 'Hello, human!' }, // TODO: unused, remove in v11\n    autoResponseTextRenderer: { type: 'string', required: false, default: '#builtin_text' },\n    autoResponsePostback: { type: 'string', required: false, default: 'YOUR_POSTBACK' },\n    paymentTesters: { type: 'any', required: false, default: [], validation: v => _.isArray(v) },\n    chatExtensionHomeUrl: { type: 'string', required: false, default: '' },\n    chatExtensionInTest: { type: 'bool', required: false, default: true },\n    chatExtensionShowShareButton: { type: 'bool', required: false, default: false },\n    webhookSubscriptionFields: {\n      type: 'any',\n      required: true,\n      default: [\n        'message_deliveries',\n        'message_reads',\n        'messages',\n        'messaging_optins',\n        'messaging_postbacks',\n        'messaging_referrals'\n      ]\n    }\n  },\n\n  init: async function(bp) {\n    bp.middlewares.register({\n      name: 'messenger.sendMessages',\n      type: 'outgoing',\n      order: 100,\n      handler: outgoingMiddleware,\n      module: 'botpress-messenger',\n      description:\n        'Sends out messages that targets platform = messenger.' +\n        ' This middleware should be placed at the end as it swallows events once sent.'\n    })\n\n    bp.messenger = {}\n\n    const knex = await bp.db.get()\n    await DB(knex).initialize()\n\n    UMM(bp) // Initializes Messenger in the UMM\n  },\n\n  ready: async function(bp, config) {\n    await initializeMessenger(bp, config)\n    incoming(bp, messenger)\n    bp.messenger._internal = messenger\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","/**\n * Messenger\n *\n * This file contains one class Messenger, which in charge of communication between\n * botpress and fb messenger.\n *\n */\n\nconst Promise = require('bluebird')\nconst EventEmitter = require('eventemitter2')\nconst crypto = require('crypto')\nconst fetch = require('node-fetch')\nconst _ = require('lodash')\nconst bodyParser = require('body-parser')\n\nimport DB from './db'\n\nfetch.promise = Promise\n\nconst normalizeString = function(str) {\n  return str.replace(/[^a-zA-Z0-9]+/g, '').toUpperCase()\n}\n\nlet db = null\n\nclass Messenger extends EventEmitter {\n  constructor(bp, config) {\n    super()\n    if (!bp || !config) {\n      throw new Error('You need to specify botpress and config')\n    }\n\n    this.setConfig(config)\n    this.bp = bp\n\n    bp.db.get().then(k => {\n      db = DB(k)\n      db.initialize()\n    })\n\n    this.app = bp.getRouter('botpress-messenger', {\n      'bodyParser.json': false,\n      auth: req => !/\\/webhook/i.test(req.originalUrl)\n    })\n\n    this.app.use(\n      bodyParser.json({\n        verify: this._verifyRequestSignature.bind(this)\n      })\n    )\n\n    this._initWebhook()\n  }\n\n  setConfig(config) {\n    this.config = Object.assign({}, this.config, config)\n  }\n\n  getConfig() {\n    return this.config\n  }\n\n  connect() {\n    return this._setupNewWebhook().then(() => this._subscribePage())\n  }\n\n  disconnect() {\n    return this._unsubscribePage()\n  }\n\n  sendTextMessage(recipientId, text, quickReplies, options) {\n    const message = { text }\n    const formattedQuickReplies = this._formatQuickReplies(quickReplies)\n    if (formattedQuickReplies && formattedQuickReplies.length > 0) {\n      message.quick_replies = formattedQuickReplies\n    }\n    return this.sendMessage(recipientId, message, options)\n  }\n\n  sendButtonTemplate(recipientId, text, buttons, options) {\n    const payload = {\n      template_type: 'button',\n      text\n    }\n    const formattedButtons = this._formatButtons(buttons)\n    payload.buttons = formattedButtons\n    return this.sendTemplate(recipientId, payload, options)\n  }\n\n  sendGenericTemplate(recipientId, elements, options) {\n    const payload = {\n      template_type: 'generic',\n      elements\n    }\n    return this.sendTemplate(recipientId, payload, options)\n  }\n\n  sendTemplate(recipientId, payload, options) {\n    const message = {\n      attachment: {\n        type: 'template',\n        payload\n      }\n    }\n    return this.sendMessage(recipientId, message, options)\n  }\n\n  async sendAttachment(recipientId, type, url, quickReplies, options) {\n    const message = {\n      attachment: {\n        type: type,\n        payload: {}\n      }\n    }\n\n    if (options.isReusable && _.isBoolean(options.isReusable)) {\n      message.attachment.payload.is_reusable = options.isReusable\n    }\n\n    if (options.attachmentId) {\n      message.attachment.payload = {\n        attachment_id: options.attachmentId\n      }\n    } else if (options.isReusable && (await db.hasAttachment(url))) {\n      const attachmentId = await db.getAttachment(url)\n\n      message.attachment.payload = {\n        attachment_id: attachmentId\n      }\n    } else {\n      message.attachment.payload.url = url\n    }\n\n    const formattedQuickReplies = this._formatQuickReplies(quickReplies)\n    if (formattedQuickReplies && formattedQuickReplies.length > 0) {\n      message.quick_replies = formattedQuickReplies\n    }\n\n    return this.sendMessage(recipientId, message, options).then(res => {\n      if (res && res.attachment_id) {\n        db.addAttachment(url, res.attachment_id)\n      }\n    })\n  }\n\n  sendAction(recipientId, action) {\n    return this.sendRequest({\n      recipient: {\n        id: recipientId\n      },\n      sender_action: action\n    })\n  }\n\n  sendMessage(recipientId, message, options) {\n    const req = () =>\n      this.sendRequest({\n        recipient: {\n          id: recipientId\n        },\n        message\n      })\n\n    if (options && options.typing) {\n      const autoTimeout = message && message.text ? 500 + message.text.length * 10 : 1000\n      const timeout = typeof options.typing === 'number' ? options.typing : autoTimeout\n      return this.sendTypingIndicator(recipientId, timeout).then(req)\n    }\n\n    return req()\n  }\n\n  sendValidationRequest() {\n    const applicationID = this.config.applicationID\n    const accessToken = this.config.accessToken\n\n    return fetch(`https://graph.facebook.com/v${this.config.graphVersion}/${applicationID}/subscriptions_sample`, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        object_id: applicationID,\n        object: 'page',\n        field: 'messages',\n        custom_fields: { page_id: applicationID },\n        access_token: accessToken\n      })\n    })\n      .then(this._handleFacebookResponse)\n      .then(res => res.json())\n  }\n\n  sendRequest(body, endpoint, method) {\n    endpoint = endpoint || 'messages'\n    method = method || 'POST'\n\n    const url = `https://graph.facebook.com/v${this.config.graphVersion}/me/${endpoint}`\n    return fetch(`${url}?access_token=${this.config.accessToken}`, {\n      method,\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify(body)\n    })\n      .then(this._handleFacebookResponse)\n      .then(res => res.json())\n      .then(json => {\n        this._handleEvent('raw_send_request', {\n          url,\n          token: this.config.accessToken,\n          body,\n          endpoint,\n          method,\n          response: json\n        })\n        return json\n      })\n  }\n\n  sendThreadRequest(body, method) {\n    return this.sendRequest(body, 'thread_settings', method)\n  }\n\n  sendTypingIndicator(recipientId, milliseconds) {\n    let timeout = !milliseconds || isNaN(milliseconds) ? 0 : milliseconds\n    timeout = Math.min(20000, timeout)\n\n    if (milliseconds === true) {\n      timeout = 1000\n    }\n\n    const before = timeout > 0 ? Promise.resolve(this.sendAction(recipientId, 'typing_on')) : Promise.resolve(true)\n\n    return before.delay(timeout + 1000).then(() => this.sendAction(recipientId, 'typing_off'))\n  }\n\n  getUserProfile(userId) {\n    const token = this.config.accessToken\n    const profileFields = ['first_name', 'last_name', 'profile_pic'].concat(\n      this.config.enableAllProfileFields ? ['locale', 'timezone', 'gender'] : []\n    )\n    const url = `https://graph.facebook.com/v${this.config.graphVersion}/${userId}?fields=${profileFields.join(\n      ','\n    )}&access_token=${token}`\n\n    return fetch(url)\n      .then(this._handleFacebookResponse)\n      .then(res => res.json())\n      .catch(err => console.log(`Error getting user profile: ${err}`))\n  }\n\n  /**\n   * Create the settings to add a new chat extension home url\n   *\n   * Within the context of this app the \"show_share\" is a boolean\n   * but Facebook either wants a\n   */\n  createChatExtensionHomeUrlSetting(home_url, in_test, show_share) {\n    let show_string = 'hide'\n    if (show_share == true) {\n      show_string = 'show'\n    }\n\n    return {\n      home_url: {\n        url: home_url,\n        webview_height_ratio: 'tall',\n        in_test: in_test,\n        webview_share_button: show_string\n      }\n    }\n  }\n\n  deleteChatExtensionHomeUrlSetting() {\n    return {\n      fields: ['home_url']\n    }\n  }\n\n  deleteChatExtensionHomeUrl() {\n    const setting = this.deleteChatExtensionHomeUrlSetting()\n    return this.sendRequest(setting, 'messenger_profile', 'DELETE')\n  }\n\n  setChatExtensionHomeUrl(home_url, in_test, show_share) {\n    const setting = this.createChatExtensionHomeUrlSetting(home_url, in_test, show_share)\n    return this.sendRequest(setting, 'messenger_profile', 'POST')\n  }\n\n  // add and delete payment testers from application\n  // https://developers.facebook.com/docs/messenger-platform/thread-settings/payment#payment_test_users\n  deletePaymentTesterSetting(tester) {\n    return {\n      setting_type: 'payment',\n      payment_dev_mode_action: 'REMOVE',\n      payment_testers: [tester]\n    }\n  }\n  createPaymentTesterSetting() {\n    return {\n      setting_type: 'payment',\n      payment_dev_mode_action: 'ADD',\n      payment_testers: this.config.paymentTesters\n    }\n  }\n\n  setPaymentTesters() {\n    if (this.config.paymentTesters.length == 0) {\n      return\n    }\n    const setting = this.createPaymentTesterSetting()\n    return this.sendThreadRequest(setting, 'POST')\n  }\n  deletePaymentTester(tester) {\n    const setting = this.deletePaymentTesterSetting(tester)\n    return this.sendThreadRequest(setting, 'POST')\n  }\n\n  getPageDetails() {\n    return this._getPage()\n  }\n\n  displayGetStarted() {\n    if (this.config.displayGetStarted) {\n      return { type: 'update', field: { name: 'get_started', value: { payload: 'GET_STARTED' } } }\n    }\n\n    return { type: 'delete', field: { name: 'get_started' } }\n  }\n\n  greetingMessage() {\n    const { greetingMessage } = this.config\n    const isGreetingMessageEmpty = _.isEmpty(this.config.greetingMessage)\n\n    if (isGreetingMessageEmpty) {\n      return { type: 'delete', field: { name: 'greeting' } }\n    }\n\n    return {\n      type: 'update',\n      field: {\n        name: 'greeting',\n        value: [\n          {\n            locale: 'default',\n            text: greetingMessage\n          }\n        ]\n      }\n    }\n  }\n\n  persistentMenu() {\n    const { composerInputDisabled, persistentMenu, persistentMenuItems } = this.config\n\n    if (!persistentMenu) {\n      return { type: 'delete', field: { name: 'persistent_menu' } }\n    }\n\n    return {\n      type: 'update',\n      field: {\n        name: 'persistent_menu',\n        value: [\n          {\n            // TODO: Support different menus for different locales\n            locale: 'default',\n            composer_input_disabled: composerInputDisabled,\n            call_to_actions: this._formatButtons(this._reformatPersistentMenuItems(persistentMenuItems))\n          }\n        ]\n      }\n    }\n  }\n\n  targetAudience() {\n    const { targetAudience, targetAudienceOpenToSome, targetAudienceCloseToSome } = this.config\n\n    switch (targetAudience) {\n      case 'openToAll':\n        return { type: 'update', field: { name: 'target_audience', value: { audience_type: 'all' } } }\n      case 'closeToAll':\n        return { type: 'update', field: { name: 'target_audience', value: { audience_type: 'none' } } }\n      case 'openToSome':\n        return {\n          type: 'update',\n          field: {\n            name: 'target_audience',\n            value: {\n              audience_type: 'custom',\n              countries: {\n                whitelist: targetAudienceOpenToSome.split(/, ?/g)\n              }\n            }\n          }\n        }\n      case 'closeToSome':\n        return {\n          type: 'update',\n          field: {\n            name: 'target_audience',\n            value: {\n              audience_type: 'custom',\n              countries: {\n                blacklist: targetAudienceCloseToSome.split(/, ?/g)\n              }\n            }\n          }\n        }\n      default:\n        return { type: 'update', field: { name: 'target_audience', value: { audience_type: 'all' } } }\n    }\n  }\n\n  chatExtensionHomeUrl() {\n    const { chatExtensionHomeUrl, chatExtensionShowShareButton, chatExtensionInTest } = this.config\n\n    if (!chatExtensionHomeUrl) {\n      return { type: 'delete', field: { name: 'home_url' } }\n    }\n\n    return {\n      type: 'update',\n      field: {\n        name: 'home_url',\n        value: {\n          url: chatExtensionHomeUrl,\n          webview_height_ratio: 'tall',\n          webview_share_button: chatExtensionShowShareButton ? 'show' : 'hide',\n          in_test: chatExtensionInTest\n        }\n      }\n    }\n  }\n\n  trustedDomains() {\n    const { trustedDomains, chatExtensionHomeUrl } = this.config\n    if (!_.isEmpty(chatExtensionHomeUrl) && trustedDomains.indexOf(chatExtensionHomeUrl) === -1) {\n      trustedDomains.push(chatExtensionHomeUrl)\n    }\n\n    if (_.isEmpty(trustedDomains)) {\n      return { type: 'next' }\n    }\n\n    return { type: 'update', field: { name: 'whitelisted_domains', value: trustedDomains } }\n  }\n\n  paymentTesters() {\n    const { paymentTesters } = this.config\n\n    return { type: 'update', field: { name: 'payment_settings', value: { testers: paymentTesters } } }\n  }\n\n  updateSettings() {\n    const messageConfigKeys = Object.keys(this.config)\n\n    const profileFields = messageConfigKeys.reduce(\n      (settings, key) => {\n        if (!this[key]) {\n          return settings\n        }\n\n        const { type, field } = this[key]()\n\n        if (type === 'next') {\n          return settings\n        }\n\n        if (type === 'update') {\n          settings.update[field.name] = field.value\n        }\n\n        if (type === 'delete') {\n          settings.delete.push(field.name)\n        }\n\n        return settings\n      },\n      { update: {}, delete: [] }\n    )\n\n    this.sendRequest({ fields: profileFields.delete }, 'messenger_profile', 'DELETE')\n    this.sendRequest(profileFields.update, 'messenger_profile', 'POST')\n  }\n\n  module(factory) {\n    return factory.apply(this, [this])\n  }\n\n  _formatButtons(buttons) {\n    return (\n      buttons &&\n      buttons.map(button => {\n        if (typeof button === 'string') {\n          return {\n            type: 'postback',\n            title: button,\n            payload: 'BUTTON_' + normalizeString(button)\n          }\n        }\n        return button\n      })\n    )\n  }\n\n  _formatQuickReplies(quickReplies) {\n    return (\n      quickReplies &&\n      quickReplies.map(reply => {\n        if (typeof reply === 'string') {\n          return {\n            content_type: 'text',\n            title: reply,\n            payload: 'QR_' + normalizeString(reply)\n          }\n        } else if (reply && reply.title) {\n          return {\n            content_type: reply.content_type || 'text',\n            title: reply.title,\n            payload: reply.payload || 'QR_' + normalizeString(reply.title),\n            image_url: reply.image_url\n          }\n        }\n        return reply\n      })\n    )\n  }\n\n  _handleEvent(type, event) {\n    this.emit(type, event)\n  }\n\n  _handleMessageEvent(event) {\n    const text = event.message.text\n    if (!text) {\n      return\n    }\n\n    this._handleEvent('message', event)\n\n    if (event.message && this.config.automaticallyMarkAsRead) {\n      this.sendAction(event.sender.id, 'mark_seen')\n    }\n  }\n\n  _handleAttachmentEvent(event) {\n    this._handleEvent('attachment', event)\n\n    if (event.message && this.config.automaticallyMarkAsRead) {\n      this.sendAction(event.sender.id, 'mark_seen')\n    }\n  }\n\n  _handlePostbackEvent(event) {\n    const payload = event.postback.payload\n    if (payload) {\n      this._handleEvent(`postback:${payload}`, event)\n    }\n    this._handleEvent('postback', event)\n  }\n\n  _handleQuickReplyEvent(event) {\n    const payload = event.message.quick_reply && event.message.quick_reply.payload\n    if (payload) {\n      this._handleEvent(`quick_reply:${payload}`, event)\n    }\n    this._handleEvent('quick_reply', event)\n\n    if (event.message && this.config.automaticallyMarkAsRead) {\n      this.sendAction(event.sender.id, 'mark_seen')\n    }\n  }\n\n  _handleFacebookResponse(res) {\n    if (!res) {\n      return\n    }\n\n    if (res.status < 400) {\n      return res\n    }\n\n    let errorMessage = 'An error has been returned by Facebook API.'\n    errorMessage += '\\nStatus: ' + res.status + ' (' + res.statusText + ')'\n\n    return Promise.resolve(true)\n      .then(() => res.json && res.json())\n      .then(json => {\n        errorMessage += '\\n' + json.error.message\n        if (json.error.error_user_title) {\n          errorMessage += '\\n' + json.error.error_user_title\n          errorMessage += '\\n' + json.error.error_user_msg\n        }\n      })\n      .finally(() => {\n        throw new Error(errorMessage)\n      })\n  }\n\n  _initWebhook() {\n    this.app.get('/webhook', (req, res) => {\n      if (req.query['hub.mode'] === 'subscribe' && req.query['hub.verify_token'] === this.config.verifyToken) {\n        res.status(200).send(req.query['hub.challenge'])\n      } else {\n        console.error('Failed validation. Make sure the validation tokens match.')\n        res.sendStatus(403)\n      }\n    })\n\n    this.app.post('/webhook', (req, res) => {\n      const data = req.body\n      if (data.object !== 'page') {\n        return\n      }\n\n      this._handleEvent('raw_webhook_body', data)\n\n      // Iterate over each entry. There may be multiple if batched.\n      data.entry.forEach(entry => {\n        if (entry && !entry.messaging) {\n          return\n        }\n        // Iterate over each messaging event\n        entry.messaging.forEach(event => {\n          if (event.message && event.message.is_echo && !this.config.broadcastEchoes) {\n            return\n          }\n          if (event.message && event.message.text) {\n            if (event.message.quick_reply) {\n              this._handleQuickReplyEvent(event)\n            } else {\n              this._handleMessageEvent(event)\n            }\n          } else if (event.message && event.message.attachments) {\n            this._handleAttachmentEvent(event)\n          } else if (event.postback) {\n            this._handlePostbackEvent(event)\n          } else if (event.delivery) {\n            this._handleEvent('delivery', event)\n          } else if (event.read) {\n            this._handleEvent('read', event)\n          } else if (event.account_linking) {\n            this._handleEvent('account_linking', event)\n          } else if (event.optin) {\n            this._handleEvent('optin', event)\n          } else if (event.referral) {\n            this._handleEvent('referral', event)\n          } else if (event.payment) {\n            this._handleEvent('payment', event)\n          } else {\n            console.log('Webhook received unknown event: ', event)\n          }\n        })\n      })\n\n      // Must send back a 200 within 20 seconds or the request will time out.\n      res.sendStatus(200)\n    })\n  }\n\n  _verifyRequestSignature(req, res, buf) {\n    if (!/^\\/webhook/i.test(req.path)) {\n      return\n    }\n\n    const signature = req.headers['x-hub-signature']\n    if (!signature) {\n      throw new Error(\"Couldn't validate the request signature.\")\n    } else {\n      const [, hash] = signature.split('=')\n      const expectedHash = crypto\n        .createHmac('sha1', this.config.appSecret)\n        .update(buf)\n        .digest('hex')\n\n      if (hash != expectedHash) {\n        throw new Error(\"Couldn't validate the request signature.\")\n      }\n    }\n  }\n\n  _reformatPersistentMenuItems() {\n    if (this.config.persistentMenu && this.config.persistentMenuItems) {\n      return this.config.persistentMenuItems.map(item => {\n        if (item.value && item.type === 'postback') {\n          item.payload = item.value\n          delete item.value\n        } else if (item.value && item.type === 'url') {\n          item.url = item.value\n          item.type = 'web_url'\n          delete item.value\n        }\n        return item\n      })\n    }\n  }\n\n  _setupNewWebhook() {\n    const oAuthUrl =\n      `https://graph.facebook.com/v${this.config.graphVersion}/oauth/access_token` +\n      '?client_id=' +\n      this.config.applicationID +\n      '&client_secret=' +\n      this.config.appSecret +\n      '&grant_type=client_credentials'\n\n    const url = `https://graph.facebook.com/v${this.config.graphVersion}/${this.config\n      .applicationID}/subscriptions?access_token=`\n\n    return fetch(oAuthUrl)\n      .then(this._handleFacebookResponse)\n      .then(res => res.json())\n      .then(json => json.access_token)\n      .then(token =>\n        fetch(url + token, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            object: 'page',\n            callback_url: 'https://' + this.config.hostname + '/api/botpress-messenger/webhook',\n            verify_token: this.config.verifyToken,\n            fields: this.config.webhookSubscriptionFields\n          })\n        })\n      )\n      .then(this._handleFacebookResponse)\n      .then(res => res.json())\n  }\n\n  _subscribePage() {\n    const url =\n      `https://graph.facebook.com/v${this.config.graphVersion}/me/subscribed_apps?access_token=` +\n      this.config.accessToken\n    const subscribed_fields = [\n      'messages',\n      'message_deliveries',\n      'messaging_referrals',\n      'messaging_postbacks',\n      'messaging_optins'\n    ]\n\n    return fetch(url, {\n      method: 'POST',\n      body: JSON.stringify({ subscribed_fields }),\n      headers: { 'Content-Type': 'application/json' }\n    })\n      .then(this._handleFacebookResponse)\n      .then(res => res.json())\n      .catch(err => console.log(err))\n  }\n\n  _unsubscribePage() {\n    const url =\n      `https://graph.facebook.com/v${this.config.graphVersion}/me/subscribed_apps?access_token=` +\n      this.config.accessToken\n\n    return fetch(url, { method: 'DELETE' })\n      .then(this._handleFacebookResponse)\n      .then(res => res.json())\n      .catch(err => console.log(err))\n  }\n\n  _getPage() {\n    const url = `https://graph.facebook.com/v${this.config.graphVersion}/me/?access_token=` + this.config.accessToken\n\n    return fetch(url, { method: 'GET' })\n      .then(this._handleFacebookResponse)\n      .then(res => res.json())\n      .catch(err => console.log(err))\n  }\n}\n\nmodule.exports = Messenger\n\n\n\n// WEBPACK FOOTER //\n// ./src/messenger.js","module.exports = require(\"botpress\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress\"\n// module id = 8\n// module chunks = 0","module.exports = require(\"eventemitter2\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"eventemitter2\"\n// module id = 9\n// module chunks = 0","module.exports = require(\"crypto\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"crypto\"\n// module id = 10\n// module chunks = 0","module.exports = require(\"node-fetch\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"node-fetch\"\n// module id = 11\n// module chunks = 0","module.exports = require(\"body-parser\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"body-parser\"\n// module id = 12\n// module chunks = 0","import LRU from 'lru-cache'\n\nimport Users from './users'\nimport outgoing from './outgoing'\nimport _ from 'lodash'\n\nmodule.exports = (bp, messenger) => {\n  const users = Users(bp, messenger)\n\n  const logger = bp.logger\n\n  const messagesCache = LRU({\n    max: 10000,\n    maxAge: 60 * 60 * 1000\n  })\n\n  const preprocessEvent = payload => {\n    const userId = payload.sender && payload.sender.id\n    const mid = payload.message && payload.message.mid\n\n    if (mid && !messagesCache.has(mid)) {\n      // We already processed this message\n      payload.alreadyProcessed = true\n    } else {\n      // Mark it as processed\n      messagesCache.set(mid, true)\n    }\n\n    return users.getOrFetchUserProfile(userId)\n  }\n\n  messenger.on('message', e => {\n    preprocessEvent(e).then(profile => {\n      // push the message to the incoming middleware\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'message',\n        user: profile,\n        text: e.message.text,\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('attachment', e => {\n    preprocessEvent(e).then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'attachments',\n        user: profile,\n        text: e.message.attachments.length + ' attachments',\n        raw: e\n      })\n      e.message.attachments.forEach(att => {\n        bp.middlewares.sendIncoming({\n          platform: 'facebook',\n          type: att.type,\n          user: profile,\n          text: att.payload.url ? att.payload.url : JSON.stringify(att.payload),\n          raw: att\n        })\n      })\n    })\n  })\n\n  messenger.on('postback', e => {\n    preprocessEvent(e).then(async profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'postback',\n        user: profile,\n        text: e.postback.payload,\n        raw: e\n      })\n\n      if (e.postback.payload === 'GET_STARTED') {\n        const mConfig = messenger.getConfig()\n\n        if (mConfig.displayGetStarted && mConfig.autoResponseOption == 'autoResponseTextRenderer') {\n          try {\n            const options = mConfig.autoResponseText ? { text: mConfig.autoResponseText } : {}\n\n            await bp.renderers.sendToUser(profile.id, mConfig.autoResponseTextRenderer, options)\n          } catch (err) {\n            logger.warn('unavailable \"autoResponseTextRenderer\"')\n          }\n        }\n\n        if (mConfig.displayGetStarted && mConfig.autoResponseOption == 'autoResponsePostback') {\n          bp.middlewares.sendIncoming({\n            platform: 'facebook',\n            type: 'postback',\n            user: profile,\n            text: mConfig.autoResponsePostback,\n            raw: e\n          })\n        }\n      }\n    })\n  })\n\n  messenger.on('quick_reply', e => {\n    preprocessEvent(e).then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'quick_reply',\n        user: profile,\n        text: e.message.quick_reply.payload,\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('delivery', e => {\n    _.values(outgoing.pending).forEach(pending => {\n      const recipient = pending.event.raw.to\n      if (e.sender.id === recipient && pending.event.raw.waitDelivery) {\n        if (_.includes(e.delivery.mids, pending.mid)) {\n          pending.resolve(e)\n          delete outgoing.pending[pending.event.__id]\n        }\n      }\n    })\n\n    preprocessEvent(e).then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'delivery',\n        user: profile,\n        text: e.delivery.watermark.toString(),\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('read', e => {\n    _.values(outgoing.pending).forEach(pending => {\n      const recipient = pending.event.raw.to\n      if (e.sender.id === recipient) {\n        if (pending.event.raw.waitRead && pending.timestamp && pending.timestamp <= e.read.watermark) {\n          pending.resolve(e)\n          delete outgoing.pending[pending.event.__id]\n        }\n      }\n    })\n\n    preprocessEvent(e).then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'read',\n        user: profile,\n        text: e.read.watermark.toString(),\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('account_linking', e => {\n    preprocessEvent(e).then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'account_linking',\n        user: profile,\n        text: e.account_linking.authorization_code,\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('optin', e => {\n    preprocessEvent(e).then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'optin',\n        user: profile,\n        text: e.optin.ref,\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('referral', e => {\n    preprocessEvent(e).then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'referral',\n        user: profile,\n        text: e.referral.ref,\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('payment', e => {\n    preprocessEvent(e).then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'payment',\n        text: 'payment',\n        user: profile,\n        payment: e.payment,\n        raw: e\n      })\n    })\n  })\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/incoming.js","module.exports = require(\"lru-cache\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lru-cache\"\n// module id = 14\n// module chunks = 0","import util from 'util'\nimport _ from 'lodash'\n\nimport actions from './actions'\n\nconst QUICK_REPLY_PAYLOAD = /\\<(.+)\\>\\s(.+)/i\n\nfunction processButtons(buttons, blocName) {\n  return processQuickReplies(buttons, blocName).map(button => {\n    if (button.payload && button.title && _.isNil(button.type)) {\n      return Object.assign(button, { type: 'postback' })\n    }\n\n    return button\n  })\n}\n\nfunction processQuickReplies(qrs, blocName) {\n  if (!_.isArray(qrs)) {\n    throw new Error('Expected quick_replies to be an array')\n  }\n\n  return qrs.map(qr => {\n    if (_.isString(qr) && QUICK_REPLY_PAYLOAD.test(qr)) {\n      let [, payload, text] = QUICK_REPLY_PAYLOAD.exec(qr)\n\n      // <.HELLO> becomes <BLOCNAME.HELLO>\n      if (payload.startsWith('.')) {\n        payload = blocName + payload\n      }\n\n      return {\n        title: text,\n        payload: payload.toUpperCase()\n      }\n    }\n\n    return qr\n  })\n}\n\nfunction amendButtons(obj, blocName) {\n  if (!_.isPlainObject(obj)) {\n    return obj\n  }\n\n  return _.mapValues(obj, (value, key) => {\n    if (_.isPlainObject(value)) {\n      return amendButtons(value, blocName)\n    } else if (_.isArray(value)) {\n      if (key === 'buttons') {\n        return amendButtons(processButtons(value, blocName))\n      }\n      return value.map(v => amendButtons(v, blocName))\n    } else {\n      return value\n    }\n  })\n}\n\nfunction getUserId(event) {\n  const userId =\n    _.get(event, 'user.userId') ||\n    _.get(event, 'raw.userId') ||\n    _.get(event, 'userId') ||\n    _.get(event, 'raw.from') ||\n    _.get(event, 'user.id') ||\n    _.get(event, 'raw.user.id')\n\n  if (!userId) {\n    throw new Error('Could not find userId in the incoming event.')\n  }\n\n  if (userId.startsWith('facebook:')) {\n    return userId.substr('facebook:'.length)\n  }\n\n  return userId\n}\n\nfunction processOutgoing({ event, blocName, instruction }) {\n  const ins = Object.assign({}, instruction) // Create a shallow copy of the instruction\n\n  ////////\n  // PRE-PROCESSING\n  ////////\n\n  const optionsList = ['quick_replies', 'waitRead', 'waitDelivery', 'typing', 'tag', '__platformSpecific', 'on']\n\n  const options = _.pick(instruction, optionsList)\n\n  for (const prop of optionsList) {\n    delete ins[prop]\n  }\n\n  if (options.quick_replies) {\n    options.quick_replies = processQuickReplies(options.quick_replies, blocName)\n  }\n\n  /////////\n  /// Processing\n  /////////\n\n  if (!_.isNil(instruction.template_type)) {\n    const data = amendButtons(ins, blocName)\n    return actions.createTemplate(getUserId(event), data, options)\n  }\n\n  for (const attr of ['image', 'audio', 'video', 'file']) {\n    if (!_.isNil(instruction[attr])) {\n      return actions.createAttachment(getUserId(event), attr, ins[attr], options)\n    }\n  }\n\n  if (!_.isNil(instruction.attachment)) {\n    return actions.createAttachment(\n      getUserId(event),\n      instruction.type || instruction.attachment,\n      ins.url || instruction.attachment,\n      options\n    )\n  }\n\n  if (!_.isNil(instruction.text)) {\n    return actions.createText(getUserId(event), instruction.text, options)\n  }\n\n  ////////////\n  /// POST-PROCESSING\n  ////////////\n\n  // Nothing to post-process yet\n\n  ////////////\n  /// INVALID INSTRUCTION\n  ////////////\n\n  const strRep = util.inspect(instruction, false, 1)\n  throw new Error(`Unrecognized instruction on Facebook Messenger in bloc '${blocName}': ${strRep}`)\n}\n\n////////////\n/// TEMPLATES\n////////////\n\nfunction getTemplates() {\n  return [\n    {\n      type: 'Text - Single message',\n      template: 'block_name_sm:\\n  - Text goes here..'\n    },\n    {\n      type: 'Text - Multiple messages',\n      template: 'block_name_mm:\\n  - Text goes here..(1)\\n  - Text goes here..(2)'\n    },\n    {\n      type: 'Text - Random message',\n      template: 'block_name_rm:\\n  - text:\\n    - Text goes here..(1)\\n    - Text goes here..(2)'\n    },\n    {\n      type: 'Typing - Message with typing',\n      template: 'block_name_bm:\\n  - text: Text goes here..(1)\\n    typing: 1000ms'\n    },\n    {\n      type: 'Text - Quick replies',\n      template:\n        'block_name_qr:\\n  - text: Text goes here..\\n    quick_replies:\\n    - <POSTBACK_1> Button..(1)\\n    - <POSTBACK_2> Button..(2)'\n    },\n    {\n      type: 'Attachment - Image',\n      template: 'block_image:\\n  - on: facebook\\n    image: https://botpress.io/static/img/nobg_primary_black.png'\n    },\n    {\n      type: 'Attachment - Video',\n      template: 'block_video:\\n  - on: facebook\\n    video: https://www.youtube.com/watch?v=QIokUU4HAKU'\n    },\n    {\n      type: 'Template - Generic',\n      template:\n        'block_generic:\\n  - on: facebook\\n    template_type: generic\\n    elements:\\n    - title: Welcome to Botpress\\n      image_url: https://botpress.io/static/img/grey_bg_primary.png\\n      subtitle: This is a great building framework\\n      default_action:\\n      - type: web_url\\n        url: https://botpress.io\\n        messenger_extensions: false\\n        webview_height_ratio: tall\\n        fallback_url: https://botpress.io\\n      buttons:\\n      - <BTN_RANDOM> Random cat videos\\n      - type: postback\\n        title: This button gives the same thing\\n        payload: BTN_RANDOM\\n      - type: web_url\\n        url: https://youtube.com/?q=cats\\n        title: Cats on Youtube'\n    },\n    {\n      type: 'Template - Carousel',\n      template:\n        'block_carousel:\\n  - on: facebook\\n    template_type: generic\\n    elements:\\n    - title: Welcome to Botpress\\n      image_url: https://botpress.io/static/img/grey_bg_primary.png\\n      subtitle: This is a great building framework\\n      default_action:\\n      - type: web_url\\n        url: https://botpress.io\\n        messenger_extensions: false\\n        webview_height_ratio: tall\\n        fallback_url: https://botpress.io\\n      buttons:\\n      - <BTN_RANDOM> Random cat videos\\n      - type: postback\\n        title: This button gives the same thing\\n        payload: BTN_RANDOM\\n      - type: web_url\\n        url: https://youtube.com/?q=cats\\n        title: Cats on Youtube\\n    - title: Bienvenido a Botpress\\n      image_url: https://botpress.io/static/img/nobg_primary_black.png\\n      subtitle: Este es un gran marco de construcción\\n      default_action:\\n      - type: web_url\\n        url: https://botpress.io\\n        messenger_extensions: false\\n        webview_height_ratio: tall\\n        fallback_url: https://botpress.io\\n      buttons:\\n      - <BTN_RANDOM> Videos de perros al azar\\n      - type: postback\\n        title: Este botón da lo mismo\\n        payload: BTN_RANDOM\\n      - type: web_url\\n        url: https://youtube.com/?q=cats\\n        title: Gatos en Youtube'\n    }\n  ]\n}\n\nmodule.exports = bp => {\n  const [renderers, registerConnector] = _.at(bp, ['renderers', 'renderers.registerConnector'])\n\n  renderers &&\n    registerConnector &&\n    registerConnector({\n      platform: 'facebook',\n      processOutgoing: args => processOutgoing(Object.assign({}, args, { bp })),\n      templates: getTemplates()\n    })\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/umm.js","module.exports = require(\"util\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"util\"\n// module id = 16\n// module chunks = 0","import _ from 'lodash'\nimport Promise from 'bluebird'\nimport outgoing from './outgoing'\n\nconst create = obj => {\n  let resolve = null\n  let reject = null\n  const promise = new Promise((r, rj) => {\n    resolve = r\n    reject = rj\n  })\n\n  const messageId = new Date().toISOString() + Math.random()\n\n  const newEvent = Object.assign(\n    {\n      _promise: promise,\n      _resolve: resolve,\n      _reject: reject,\n      __id: messageId\n    },\n    obj\n  )\n\n  outgoing.pending[messageId] = {\n    event: newEvent,\n    resolve: resolve,\n    reject: reject\n  }\n\n  return newEvent\n}\n\nconst validateUserId = userId => {\n  if (!/[0-9]+/.test(userId)) {\n    throw new Error('Invalid userId')\n  }\n}\n\nconst validateText = text => {\n  if (typeof text !== 'string' || text.length > 640) {\n    throw new Error('Text must be a string less than 640 chars.')\n  }\n}\n\nconst validateQuickReply = quick_reply => {\n  if (typeof quick_reply !== 'string') {\n    if (\n      !quick_reply ||\n      (typeof quick_reply.title !== 'string' &&\n        !_.includes(['location', 'user_email', 'user_phone_number'], quick_reply.content_type))\n    ) {\n      throw new Error(\n        'Expected quick_reply to be a string or an object' +\n          'with a title or one of these content_types: location, user_email, user_phone_number'\n      )\n    }\n  }\n}\n\nconst validateQuickReplies = quick_replies => {\n  if (!_.isArray(quick_replies)) {\n    throw new Error('quick_replies must be an array')\n  }\n\n  _.forEach(quick_replies, validateQuickReply)\n}\n\nconst validateTyping = typing => {\n  if (!_.isBoolean(typing) && !_.isNumber(typing)) {\n    throw new Error('Expected typing to be a boolean of a number')\n  }\n}\n\nconst validateAttachmentType = type => {\n  if (typeof type !== 'string') {\n    throw new Error('Expected attachment type to be a text')\n  }\n\n  if (!_.includes(['image', 'video', 'audio', 'file'], type.toLowerCase())) {\n    throw new Error('Invalid attachment type')\n  }\n}\n\nconst validateUrl = url => {\n  if (typeof url !== 'string') {\n    throw new Error('Expected URL to be a string')\n  }\n}\n\nconst validateTemplatePayload = payload => {\n  if (!_.isPlainObject(payload)) {\n    throw new Error('Template payload must be a plain object')\n  }\n\n  if (typeof payload.template_type !== 'string') {\n    throw new Error('\"template_type\" must be set')\n  }\n}\n\nconst validatePersistentMenu = elements => {\n  if (!_.isArray(elements)) {\n    throw new Error('Expected elements to be an array')\n  }\n\n  _.forEach(elements, element => {\n    if (!_.isPlainObject(element)) {\n      throw new Error('Expected element to be a plain object')\n    }\n  })\n}\n\nconst createText = (userId, text, options) => {\n  validateUserId(userId)\n  validateText(text)\n\n  if (options && options.quick_replies) {\n    validateQuickReplies(options.quick_replies)\n  }\n\n  if (options && options.typing) {\n    validateTyping(options.typing)\n  }\n\n  return create({\n    platform: 'facebook',\n    type: 'text',\n    text: text,\n    raw: {\n      to: userId,\n      message: text,\n      typing: options && options.typing,\n      quick_replies: options && options.quick_replies,\n      waitRead: options && options.waitRead,\n      waitDelivery: options && options.waitDelivery\n    }\n  })\n}\n\nconst createAttachment = (userId, type, url, options) => {\n  validateUserId(userId)\n  validateAttachmentType(type)\n\n  if (_.isNull(url) && !(options && options.attachmentId)) {\n    throw new Error('If URL is null, you must pass an attachment_id on options object')\n  } else if (options && options.attachmentId) {\n    validateText(options.attachmentId)\n  } else {\n    validateUrl(url)\n  }\n\n  if (options && options.quick_replies) {\n    validateQuickReplies(options.quick_replies)\n  }\n\n  if (options && options.typing) {\n    validateTyping(options.typing)\n  }\n\n  return create({\n    platform: 'facebook',\n    type: 'attachment',\n    text: 'Attachment (' + type + ') : ' + url,\n    raw: {\n      to: userId,\n      type: type,\n      url: url,\n      isReusable: options && options.isReusable,\n      attachmentId: options && options.attachmentId,\n      typing: options && options.typing,\n      quick_replies: options && options.quick_replies,\n      waitRead: options && options.waitRead,\n      waitDelivery: options && options.waitDelivery\n    }\n  })\n}\n\nconst createTemplate = (userId, payload, options) => {\n  validateUserId(userId)\n  validateTemplatePayload(payload)\n\n  if (options && options.typing) {\n    validateTyping(options.typing)\n  }\n\n  return create({\n    platform: 'facebook',\n    type: 'template',\n    text: 'Template (' + payload.template_type + ')',\n    raw: {\n      to: userId,\n      payload: payload,\n      typing: options && options.typing,\n      waitRead: options && options.waitRead,\n      waitDelivery: options && options.waitDelivery\n    }\n  })\n}\n\nconst createTyping = (userId, typing) => {\n  validateUserId(userId)\n  validateTyping(typing)\n\n  return create({\n    platform: 'facebook',\n    type: 'typing',\n    text: 'Typing: ' + typing,\n    raw: {\n      to: userId,\n      typing: typing\n    }\n  })\n}\n\nconst createSeen = userId => {\n  validateUserId(userId)\n\n  return create({\n    platform: 'facebook',\n    type: 'seen',\n    text: 'Mark as seen',\n    raw: {\n      to: userId\n    }\n  })\n}\n\nconst createPersistentMenu = elements => {\n  if (!elements) {\n    return create({\n      platform: 'facebook',\n      type: 'persistent_menu',\n      text: 'Delete the persistent menu',\n      raw: {\n        delete: true\n      }\n    })\n  }\n\n  validatePersistentMenu(elements)\n  return create({\n    platform: 'facebook',\n    type: 'persistent_menu',\n    text: 'Set persistent menu: ' + elements.length + ' items',\n    raw: {\n      delete: false,\n      elements: elements\n    }\n  })\n}\n\nconst createGreetingText = text => {\n  if (text && text.length > 160) {\n    throw new Error('Greeting text must be less than 160 chars')\n  }\n\n  return create({\n    platform: 'facebook',\n    type: 'greeting_text',\n    text: 'Set greeting text: ' + text,\n    raw: {\n      text: text\n    }\n  })\n}\n\nconst createGetStarted = postback => {\n  return create({\n    platform: 'facebook',\n    type: 'get_started',\n    text: 'Setting get started button: ' + !!postback,\n    raw: {\n      enabled: !!postback,\n      postback: postback\n    }\n  })\n}\n\nconst createWhitelistedDomains = domains => {\n  if (domains && !_.every(domains, _.isString)) {\n    throw new Error('Expected domains to be a list of string')\n  }\n\n  return create({\n    platform: 'facebook',\n    type: 'whitelisted_domains',\n    text: 'Setting whitelisted domains',\n    raw: {\n      domains: domains\n    }\n  })\n}\n\nmodule.exports = {\n  createText,\n  createAttachment,\n  createTemplate,\n  createTyping,\n  createSeen,\n  createGetStarted,\n  createPersistentMenu,\n  createGreetingText,\n  createWhitelistedDomains\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/actions.js"],"sourceRoot":""}